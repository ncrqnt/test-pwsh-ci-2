name: Publish module
on:
  workflow_dispatch:

jobs:
  publish:
    name: Publish module
    runs-on: ubuntu-latest
    steps:
      - name: Download 'NewBuild' artifact
        uses: actions/download-artifact@v2.0.10
        with:
          name: NewBuild
      
      - name: Publish GitHub release
        id: githubrelease
        uses: xresloader/upload-to-github-release@v1.3.2
        with:
          file: .\NewBuild\*
          prerelease: true
          tags: true
      
      - name: Publish to PSGallery
        if: steps.githubrelease.conclusion == success
        shell: pwsh
        env:
          PSGALLERY_TOKEN: ${{ secrets.PSGALLERY_TOKEN }}
        run: Publish-Module -Name ./NewBuild/*/CITest.psd1 -NuGetApiKey $env:PSGALLERY_TOKEN -AllowPrerelease -Verbose
